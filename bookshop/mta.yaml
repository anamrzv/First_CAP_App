## Generated mta.yaml based on template version 0.4.0
## appName = test
## language=nodejs; multitenant=false
## approuter=
_schema-version: '3.1'
ID: test
version: 1.0.0
description: "A simple CAP project."

parameters:
  deploy_mode: html5-repo
  enable-parallel-deployments: false
   
build-parameters:
  before-all:
    - builder: custom
      commands:
        - npm install --production
        - npx -p @sap/cds-dk cds build --production

modules:
 # --------------------- SERVER MODULE ------------------------
- name: test-srv
  type: nodejs
  path: gen/srv
  parameters:
    buildpack: nodejs_buildpack
  requires:
    - name: test-db
    - name: test-uaa
    - name: test-destination
  provides:
    - name: srv-api      # required by consumers of CAP services (e.g. approuter)
      properties:
        srv-url: ${default-url}
  build-parameters:
    ignore: [".env","./node_modules"]

 # -------------------- SIDECAR MODULE ------------------------
- name: test-db-deployer
  type: hdb
  path: gen/db  
  parameters:
    buildpack: nodejs_buildpack
  build-parameters:
    ignore: [".env","./node_modules"]
  requires:
    - name: test-db

 #-----------------Managed approuter
- name: test-destination-content
  type: com.sap.application.content
  requires: 
    - name: test-destination
      parameters: 
        content-target: true
    - name: test-html5-repo-host
      parameters:
        service-key:
          name: test-html5-repo-host-key
    - name: test-uaa
      parameters:
        service-key:
          name: test-uaa-key
  parameters:
    content:
      subaccount:
        destinations:
          - Name: test-destination-html5
            ServiceInstanceName: test-html5-repo-host     
            ServiceKeyName:  test-html5-repo-host-key
            sap.cloud.service: testy.app
          - Authentication: OAuth2UserTokenExchange
            Name: test-destination-uaa
            ServiceInstanceName: test-uaa
            ServiceKeyName: test-uaa-key
            sap.cloud.service: testy.app
        existing_destinations_policy: update
  build-parameters:
    no-source: true

 # -------------------- APPROUTER MODULE ------------------------


 # -------------------- WEBAPP DEPLOYER MODULE ------------------------

- name: project1-deployer
  type: com.sap.application.content
  path: .
  requires:
    - name: test-html5-repo-host
      parameters:
        content-target: true
  build-parameters:
    build-result: resources
    requires:
      - artifacts:
        - project1.zip
        name: project1
        target-path: resources/
- name: project1
  type: html5
  path: app/project1
  build-parameters:
    build-result: dist
    builder: custom
    commands:
      - npm run build:cf
    supported-platforms: []


resources:
- name: test-db
  type: com.sap.xs.hdi-container
  parameters:
    service: hana  # or 'hanatrial' on trial landscapes
    service-plan: hdi-shared
  properties:
    hdi-service-name: ${service-name}

- name: test-uaa
  type: org.cloudfoundry.managed-service
  parameters:
    service: xsuaa
    service-plan: application
    path: ./xs-security.json
# ------------------------------------------------------------   
- name: test-destination 
  type: org.cloudfoundry.managed-service
  requires:
    - name: srv-api
  parameters:
    service-plan: lite
    service: destination
    config: 
      HTML5Runtime_enabled: true
      init_data:
        subaccount:
          existing_destinations_policy: update
          destinations: 
            - Name: test-destination
              URL: ~{srv-api/srv-url}
              Type: HTTP
              ProxyType: Internet    
              Authentication: NoAuthentication
              HTML5.DynamicDestination: true
              HTML5.ForwardAuthToken: true
            - Name: ui5
              URL: https://ui5.sap.com
              Type: HTTP
              ProxyType: Internet    
              Authentication: NoAuthentication

# ------------------------------------------------------------   
- name: test-html5-repo-runtime
  type: org.cloudfoundry.managed-service
  parameters:
    service-plan: app-runtime
    service: html5-apps-repo
  
- name: test-html5-repo-host
  type: org.cloudfoundry.managed-service
  parameters:
    service-plan: app-host
    service: html5-apps-repo

